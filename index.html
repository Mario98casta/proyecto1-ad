<!DOCTYPE html>
<html lang="es">
<head>
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
	<link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300&display=swap" rel="stylesheet">
    <title>Sabor Chapin</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <header>
        <div class="contenedor">
                    <div  class="logo" id="logo">
                        <img src="img/sabor_chapin_logo.png" alt="Logo de la tienda"height="60px">
                        <span>Sabor Chapin</span>
                    </div>
            
                    <div class="menu-opciones">
                        <ul>
                            <li><a href="index.html">Inicio del sabor</a></li>
                            <li><a href="oferta.html">ofertas</a></li>
                           
                        </ul>
                    </div> 
                    <div class="controles-usuario">
                        <ion-icon name="search" id="search-icon"></ion-icon>
                        <input type="text" id="search-input" placeholder="Buscar por nombre">
                        <ion-icon name="cart-outline" class="container-cart-icon"></ion-icon> 
                        <button id="btn-sign-up">INGRESAR</button>
                        <ion-icon id="btn-menu" name="menu"></ion-icon>

                        <div class="container-cart-products hidden-cart">
                            <div class="row-product"></div>
                            <div class="cart-total">
                                <p>Total a pagar: <span class="total-pagar">$0</span></p>
                                <p>Total de productos: <span id="contador-productos">0</span></p>
                            </div>
                        </div>
                        
                    </div>

                    



                    

        </div>
        
    </header>
    <main>
        <div class="body__page">

            <div class="container__card"></div>

        </div>
</main>

    <footer>
		<img src="img/sabor_chapin_logo.png" height="150px">
		<p class="copyright">&copy Copyright Sabor Chapin - 2024</p>
		<section class="buttons">
			<a href="#" class="fa fa-facebook"></a>
			<a href="#" class="fa fa-twitter"></a>
			<a href="#" class="fa fa-google-plus"></a>
			<a href="#" class="fa fa-youtube"></a>
		</section>
	</footer>
    <script src="https://kit.fontawesome.com/2c36e9b7b1.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script src="script.js">const menuOpciones = document.querySelector(".menu-opciones");
const btnSignUp = document.getElementById("btn-sign-up");
const header = document.querySelector("header");
const controlesUsuario = document.querySelector(".controles-usuario");
const contenedor = document.querySelector(".contenedor");
const btnMenu = document.getElementById("btn-menu");
const searchIcon = document.getElementById("search-icon");
const searchInput = document.getElementById("search-input");


const responsiveY = ()=>{
    if(window.innerHeight<=362){
        if(menuOpciones.classList.contains("mostrar"))
            menuOpciones.classList.add("min");
        else
            menuOpciones.classList.remove("min");
    }
    else{
        menuOpciones.classList.remove("min");
    }
};
const responsive = ()=>{
    if(window.innerWidth<=865){
        menuOpciones.children[0].appendChild(btnSignUp);
        header.appendChild(menuOpciones);
    }else{
        controlesUsuario.appendChild(btnSignUp);
        contenedor.appendChild(menuOpciones);
    }

    responsiveY();
}

btnMenu.addEventListener("click",()=>{
    menuOpciones.classList.toggle("mostrar");
    responsiveY();
});
responsive();

window.addEventListener("resize",responsive);


// Agrega un evento de clic al botón "INGRESAR"
btnSignUp.addEventListener("click", () => {
    window.location.href = "login.html";
});


// Agrega un evento de clic al ícono de búsqueda
searchIcon.addEventListener("click", () => {
    // Muestra u oculta el cuadro de búsqueda al hacer clic en el ícono
    searchInput.classList.toggle("mostrar");
    
    // Evita que el clic en el ícono de búsqueda se propague y cierre el cuadro inmediatamente
    event.stopPropagation();
});

// Agrega un manejador de clic al documento
document.addEventListener("click", (event) => {
    // Verifica si el clic ocurrió fuera del cuadro de búsqueda y el ícono de búsqueda
    if (event.target !== searchInput && event.target !== searchIcon) {
        // Oculta el cuadro de búsqueda si está visible
        if (searchInput.classList.contains("mostrar")) {
            searchInput.classList.remove("mostrar");
        }
    }
});


// Función para manejar el evento de búsqueda
const handleSearch = () => {
  const searchText = searchInput.value.toLowerCase(); // Obtener el texto ingresado en minúsculas
  const cards = document.querySelectorAll('.container__card .card'); // Obtener todas las tarjetas

  cards.forEach(card => {
      const cardText = card.textContent.toLowerCase(); // Obtener el texto de la tarjeta en minúsculas

      // Verificar si el texto de la tarjeta contiene el texto de búsqueda
      if (cardText.includes(searchText)) {
          card.style.display = 'block'; // Mostrar la tarjeta si hay coincidencia
      } else {
          card.style.display = 'none'; // Ocultar la tarjeta si no hay coincidencia
      }
  });
};

// Agregar un evento de entrada al campo de búsqueda
searchInput.addEventListener('input', handleSearch);


//conexiones


//registrar usuario
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('registro-form'); // Obtén el formulario por su id
  const usuarioInput = document.getElementById('registroUsuario');
  const contraseñaInput = document.getElementById('registroContra');
  const confirmarContraseñaInput = document.getElementById('registroConf');

  form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const usuario = usuarioInput.value;
      const contraseña = contraseñaInput.value;
      const confirmarContraseña = confirmarContraseñaInput.value;

      // Realiza la solicitud POST al servidor para registrar el usuario
      const response = await fetch('/registrar-usuario', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({ usuario, contraseña, confirmarContraseña }),
      });

      if (response.status === 201) {
          alert('Usuario registrado exitosamente');
          window.location.href = 'login.html'
      } else if (response.status === 409) {
          alert('El usuario ya existe');
      } else if (response.status === 400) {
          alert('Las contraseñas no coinciden');
      } else {
          alert('Error interno del servidor');
      }
  });
});


//iniciar sesion
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('login-form'); // Obtén el formulario por su id
    const usuarioInput = document.getElementById('usuario-input');
    const contraseñaInput = document.getElementById('contraseña-input');
  
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
  
      const usuario = usuarioInput.value;
      const contraseña = contraseñaInput.value;


  
      // Realiza la solicitud POST al servidor
      const response = await fetch('/iniciar-sesion', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ usuario, contraseña }),
      });
  
      if (response.status === 200) {
        alert('Inicio de sesión exitoso');
        window.location.href = 'Sabor_chapin.html';
      } else {
        alert('Credenciales incorrectasss');
      }
    });
  });

window.addEventListener("load", cargarTarjetas);

function cargarTarjetas() {
    // Hacer una solicitud al servidor para obtener datos de productos
    fetch('/productos')
      .then(response => response.json())
      .then(productos => {
        const container = document.querySelector('.container__card');
  
        productos.forEach(producto => {
            const card = document.createElement('div');
            card.classList.add('card');
            card.innerHTML = `
              <div class="icon">
                <img src="${producto.imagen}" height="150px">
              </div>
              <div class="info__description">
                <h2>${producto.nombre}</h2>
                <p>${producto.descripcion}</p>
                <p class="price">Precio: Q${producto.precio}</p>
                <p>Cantidad Disponible: ${producto.cantidad_disponible}</p>
                <button class="btn-add-cart">Añadir al carrito</button>
              </div>
            `;
          
            container.appendChild(card);
          
            // Verifica si el botón se está seleccionando correctamente
            const btnAddToCart = card.querySelector('.btn-add-cart');
            console.log(btnAddToCart); // Agrega esta línea para verificar si obtienes el botón
          
        
        
          // Agregar un evento de clic al botón "Añadir al carrito"
          console.log("Agregando evento de clic al botón");
            btnAddToCart.addEventListener('click', () => {
                
        });

        });
      })
      .catch(error => console.error(error));
  }
  

//**************************************************************************** */

const productsList = document.querySelector('.container__card');
const containerCartProducts = document.querySelector('.container-cart-products');
const rowProduct = document.querySelector('.row-product');
const valorTotal = document.querySelector('.total-pagar');
const countProducts = document.querySelector('#contador-productos');

let allProducts = [];

productsList.addEventListener('click', e => {
    if (e.target.classList.contains('btn-add-cart')) {
        const product = e.target.parentElement;

        const infoProduct = {
            quantity: 1,
            title: product.querySelector('h2').textContent,
            price: product.querySelector('.price').textContent,
        };

        const exits = allProducts.some(
            product => product.title === infoProduct.title
        );

        if (exits) {
            const products = allProducts.map(product => {
                if (product.title === infoProduct.title) {
                    product.quantity++;
                    return product;
                } else {
                    return product;
                }
            });
            allProducts = [...products];
        } else {
            allProducts = [...allProducts, infoProduct];
        }

        showCart(false);
    }
});

const showCart = (isRemovingProduct) => {
    if (!allProducts.length) {
        containerCartProducts.classList.add('hidden-cart');
    } else {
        containerCartProducts.classList.remove('hidden-cart');
        
        // Mostrar el carrito durante 5 segundos si se está agregando un producto
        if (!isRemovingProduct) {
            setTimeout(() => {
                containerCartProducts.classList.add('hidden-cart');
            }, 3000);
        }

        rowProduct.innerHTML = '';

        let total = 0;
        let totalOfProducts = 0;

        allProducts.forEach(product => {
            const containerProduct = document.createElement('div');
            containerProduct.classList.add('cart-product');

            containerProduct.innerHTML = `
                <div class="info-cart-product">
                    <span class="cantidad-producto-carrito">${product.quantity}</span>
                    <p class="titulo-producto-carrito">${product.title}</p>
                    <span class="precio-producto-carrito">${product.price}</span>
                    <button class="eliminar-producto">Eliminar</button>
                </div>
            `;

            // Agrega un event listener para el botón de eliminar
            containerProduct.querySelector('.eliminar-producto').addEventListener('click', () => {
                // Encuentra el índice del producto en el array allProducts
                const index = allProducts.findIndex(p => p.title === product.title);
                if (index !== -1) {
                    // Si la cantidad del producto es mayor a 1, solo reduce la cantidad
                    if (allProducts[index].quantity > 1) {
                        allProducts[index].quantity--;
                    } else {
                        // Si la cantidad es 1, elimina el producto del array allProducts
                        allProducts.splice(index, 1);
                    }
                    // Vuelve a mostrar el carrito sin aplicar el temporizador
                    showCart(true); // true indica que se está eliminando un producto
                }
            });

            rowProduct.append(containerProduct);

            // Extraer el valor numérico del precio y multiplicarlo por la cantidad del producto
            total += parseInt(product.price.match(/\d+/)) * product.quantity; // Multiplicar precio por cantidad

            totalOfProducts += product.quantity;
        });

        valorTotal.innerText = `Q${total}`;
        countProducts.innerText = totalOfProducts;
    }
};


const btnCart = document.querySelector('.container-cart-icon');

btnCart.addEventListener('click', () => {
    containerCartProducts.classList.toggle('hidden-cart');
}); </script>
    
    
   
</body>
</html>
